<!DOCTYPE html>
<html>
<head>
  <title>Web Bluetooth Serial Monitor</title>
</head>
<body>
  <button onclick="connectToDevice()">Connect</button>
  <button onclick="disconnectFromDevice()">Disconnect</button>
  <button onclick="sendMessage()">Send Message</button>

  <pre id="log"></pre>

  <script>
    let device;
    let logElement;
    let writeCharacteristic;
    let readCharacteristic;

    function log(message) {
      logElement.innerHTML += message + '\n';
    }

    async function connectToDevice() {
      try {
        logElement = document.getElementById('log');
        log('Requesting Bluetooth Device...');
        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'mpy-uart' }],
          optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
        });

        log('Connecting to GATT Server...');
        const server = await device.gatt.connect();

        log('Getting Serial Service...');
        const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');

        log('Getting Serial Port Write Characteristic...');
        writeCharacteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');

        log('Getting Serial Port Read Characteristic...');
        readCharacteristic = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');

        log('Enabling notifications...');
        await readCharacteristic.startNotifications();
        readCharacteristic.addEventListener('characteristicvaluechanged', handleData);

        log('Connected to ' + device.name);
      } catch (error) {
        log('Error: ' + error);
      }
    }

    function disconnectFromDevice() {
      if (device && device.gatt.connected) {
        device.gatt.disconnect();
        log('Disconnected');
      }
    }

    function handleData(event) {
      const value = event.target.value;
      const decoder = new TextDecoder('utf-8');
      const data = decoder.decode(value);
      log('Received: ' + data);
    }

    async function sendMessage() {
      try {
        const message = 'toggle\r\n';
        const encoder = new TextEncoder('utf-8');
        const data = encoder.encode(message);
        await writeCharacteristic.writeValue(data);
        log('Sent: ' + message);
      } catch (error) {
        log('Error: ' + error);
      }
    }
  </script>
</body>
</html>
